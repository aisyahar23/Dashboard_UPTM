{% extends "base.html" %}

{% block content %}
<div x-data="industriGajiDashboard()" x-init="init()" class="min-h-screen bg-gray-50">
    <!-- Clean Header Section -->
    <div class="bg-white border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-6 py-8">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-6 lg:space-y-0">
                <div class="flex items-center space-x-5">
                    <div class="w-16 h-16 bg-gray-900 rounded-lg flex items-center justify-center">
                        <i class="fas fa-chart-line text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-3xl font-semibold text-gray-900">
                            Employment & Industry Analytics
                        </h1>
                        <p class="text-gray-600 mt-1">Graduate employment outcomes and salary insights</p>
                        <div class="flex items-center mt-3 space-x-4">
                            <div class="flex items-center space-x-2">
                                <div class="w-2 h-2 bg-emerald-500 rounded-full"></div>
                                <span class="text-sm text-gray-500">
                                    <span x-text="kpis.total_records || 0"></span> records analyzed
                                </span>
                            </div>
                            <span x-show="loading" class="text-sm text-gray-400">
                                <i class="fas fa-spinner fa-spin mr-1"></i>Loading...
                            </span>
                        </div>
                    </div>
                </div>
                
                <!-- Action Panel -->
                <div class="flex items-center space-x-3">
                    <!-- Filters -->
                    <div class="relative" x-data="{ open: false }">
                        <button @click="open = !open" 
                                class="inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                            <i class="fas fa-filter mr-2 text-gray-400"></i>
                            Filters
                            <span x-show="activeFiltersCount > 0" 
                                  class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-900 text-white"
                                  x-text="activeFiltersCount"></span>
                        </button>
                        
                        <!-- Filter Dropdown -->
                        <div x-show="open" 
                             @click.away="open = false"
                             x-transition:enter="transition ease-out duration-200"
                             x-transition:enter-start="opacity-0 transform scale-95"
                             x-transition:enter-end="opacity-100 transform scale-100"
                             class="absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-lg border border-gray-200 z-50">
                            <div class="p-4">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-medium text-gray-900">Filter Data</h3>
                                    <button @click="clearAllFilters()" 
                                            class="text-sm text-gray-500 hover:text-gray-700">
                                        Clear all
                                    </button>
                                </div>
                                
                                <!-- Filter Options -->
                                <div class="space-y-4">
                                    <!-- Graduation Year -->
                                    <div>
                                        <label class="text-sm font-medium text-gray-700 mb-2 block">
                                            Graduation Year
                                        </label>
                                        <div class="grid grid-cols-3 gap-2">
                                            <template x-for="year in availableFilters.graduation_years || []">
                                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                                    <input type="checkbox" 
                                                           :value="year" 
                                                           x-model="filters.graduation_year"
                                                           class="rounded border-gray-300 text-gray-900 focus:ring-gray-500">
                                                    <span class="ml-2 text-sm text-gray-700" x-text="year"></span>
                                                </label>
                                            </template>
                                        </div>
                                    </div>
                                    
                                    <!-- Gender -->
                                    <div>
                                        <label class="text-sm font-medium text-gray-700 mb-2 block">
                                            Gender
                                        </label>
                                        <div class="grid grid-cols-2 gap-2">
                                            <template x-for="gender in availableFilters.genders || []">
                                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                                    <input type="checkbox" 
                                                           :value="gender" 
                                                           x-model="filters.gender"
                                                           class="rounded border-gray-300 text-gray-900 focus:ring-gray-500">
                                                    <span class="ml-2 text-sm text-gray-700" x-text="gender"></span>
                                                </label>
                                            </template>
                                        </div>
                                    </div>
                                    
                                    <!-- Employment Status -->
                                    <div>
                                        <label class="text-sm font-medium text-gray-700 mb-2 block">
                                            Employment Status
                                        </label>
                                        <div class="space-y-1">
                                            <template x-for="status in availableFilters.employment_status || []">
                                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                                    <input type="checkbox" 
                                                           :value="status" 
                                                           x-model="filters.employment_status"
                                                           class="rounded border-gray-300 text-gray-900 focus:ring-gray-500">
                                                    <span class="ml-2 text-sm text-gray-700" x-text="status"></span>
                                                </label>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-4 pt-4 border-t border-gray-200">
                                    <button @click="applyFilters(); open = false" 
                                            class="w-full bg-gray-900 text-white py-2 px-4 rounded-md text-sm font-medium hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                                        Apply Filters
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Export Button -->
                    <div class="relative" x-data="{ open: false }">
                        <button @click="open = !open" 
                                class="inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                            <i class="fas fa-download mr-2 text-gray-400"></i>
                            Export
                        </button>
                        
                        <div x-show="open" 
                             @click.away="open = false"
                             x-transition
                             class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-50">
                            <div class="py-1">
                                <button @click="exportData('csv'); open = false" 
                                        class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
                                    <i class="fas fa-file-csv mr-2 text-green-500"></i>CSV
                                </button>
                                <button @click="exportData('excel'); open = false" 
                                        class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
                                    <i class="fas fa-file-excel mr-2 text-blue-500"></i>Excel
                                </button>
                                <button @click="exportData('json'); open = false" 
                                        class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
                                    <i class="fas fa-file-code mr-2 text-purple-500"></i>JSON
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Refresh Button -->
                    <button @click="refreshData()" 
                            class="inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500"
                            :disabled="loading">
                        <i class="fas fa-sync-alt mr-2 text-gray-400" :class="{ 'animate-spin': loading }"></i>
                        Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="max-w-7xl mx-auto px-6 py-8 space-y-8">
        <!-- KPI Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <!-- Total Records -->
            <div class="bg-white p-6 rounded-lg border border-gray-200">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-users text-gray-600 text-sm"></i>
                        </div>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Total Records</p>
                        <p class="text-2xl font-semibold text-gray-900" x-text="kpis.total_records || '0'"></p>
                    </div>
                </div>
            </div>

            <!-- Employment Rate -->
            <div class="bg-white p-6 rounded-lg border border-gray-200">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-emerald-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-briefcase text-emerald-600 text-sm"></i>
                        </div>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Employment Rate</p>
                        <p class="text-2xl font-semibold text-gray-900">
                            <span x-text="(kpis.full_time_employment_rate || 0)"></span>%
                        </p>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="bg-gray-200 rounded-full h-1">
                        <div class="bg-emerald-500 h-1 rounded-full transition-all duration-1000" 
                             :style="`width: ${kpis.full_time_employment_rate || 0}%`"></div>
                    </div>
                </div>
            </div>

            <!-- Private Sector -->
            <div class="bg-white p-6 rounded-lg border border-gray-200">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-building text-blue-600 text-sm"></i>
                        </div>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Private Sector</p>
                        <p class="text-2xl font-semibold text-gray-900">
                            <span x-text="(kpis.private_sector_rate || 0)"></span>%
                        </p>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="bg-gray-200 rounded-full h-1">
                        <div class="bg-blue-500 h-1 rounded-full transition-all duration-1000" 
                             :style="`width: ${kpis.private_sector_rate || 0}%`"></div>
                    </div>
                </div>
            </div>

            <!-- Quick Employment -->
            <div class="bg-white p-6 rounded-lg border border-gray-200">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-indigo-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-clock text-indigo-600 text-sm"></i>
                        </div>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Quick Employment</p>
                        <p class="text-2xl font-semibold text-gray-900">
                            <span x-text="(kpis.quick_employment_rate || 0)"></span>%
                        </p>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="bg-gray-200 rounded-full h-1">
                        <div class="bg-indigo-500 h-1 rounded-full transition-all duration-1000" 
                             :style="`width: ${kpis.quick_employment_rate || 0}%`"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Charts Grid - Top Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Employment Status -->
            <div class="bg-white rounded-lg border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-medium text-gray-900">Employment Status</h3>
                            <p class="text-sm text-gray-500">Current employment distribution across graduates</p>
                        </div>
                        <div class="flex space-x-2">
                            <button @click="openTableModal('Employment Status')" 
                                    class="p-2 text-gray-400 hover:text-gray-600 rounded-md hover:bg-gray-100 transition-colors"
                                    title="View data table">
                                <i class="fas fa-table text-sm"></i>
                            </button>
                            <button @click="refreshChart('employment')" 
                                    class="p-2 text-gray-400 hover:text-gray-600 rounded-md hover:bg-gray-100 transition-colors"
                                    title="Refresh chart">
                                <i class="fas fa-refresh text-sm"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="p-6">
                    <div class="h-64 relative">
                        <div x-show="loading" class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-90 z-10">
                            <div class="text-center">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 mx-auto mb-2"></div>
                                <div class="text-sm text-gray-500">Loading employment data...</div>
                            </div>
                        </div>
                        <div x-show="!dataLoaded && !loading" class="absolute inset-0 flex items-center justify-center text-gray-400">
                            <div class="text-center">
                                <i class="fas fa-chart-pie text-3xl mb-2"></i>
                                <div class="text-sm">No employment data available</div>
                            </div>
                        </div>
                        <canvas id="employmentChart" class="w-full h-full"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Job Types -->
            <div class="bg-white rounded-lg border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-medium text-gray-900">Job Categories</h3>
                            <p class="text-sm text-gray-500">Distribution across different industry sectors</p>
                        </div>
                        <div class="flex space-x-2">
                            <button @click="openTableModal('Job Types')" 
                                    class="p-2 text-gray-400 hover:text-gray-600 rounded-md hover:bg-gray-100 transition-colors"
                                    title="View data table">
                                <i class="fas fa-table text-sm"></i>
                            </button>
                            <button @click="refreshChart('jobTypes')" 
                                    class="p-2 text-gray-400 hover:text-gray-600 rounded-md hover:bg-gray-100 transition-colors"
                                    title="Refresh chart">
                                <i class="fas fa-refresh text-sm"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="p-6">
                    <div class="h-64 relative">
                        <div x-show="loading" class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-90 z-10">
                            <div class="text-center">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 mx-auto mb-2"></div>
                                <div class="text-sm text-gray-500">Loading job categories...</div>
                            </div>
                        </div>
                        <div x-show="!dataLoaded && !loading" class="absolute inset-0 flex items-center justify-center text-gray-400">
                            <div class="text-center">
                                <i class="fas fa-chart-bar text-3xl mb-2"></i>
                                <div class="text-sm">No job category data available</div>
                            </div>
                        </div>
                        <canvas id="jobTypesChart" class="w-full h-full"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Grid - Bottom Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Salary Distribution -->
            <div class="bg-white rounded-lg border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-medium text-gray-900">Salary Distribution</h3>
                            <p class="text-sm text-gray-500">Current compensation ranges across positions</p>
                        </div>
                        <div class="flex space-x-2">
                            <button @click="openTableModal('Salary Distribution')" 
                                    class="p-2 text-gray-400 hover:text-gray-600 rounded-md hover:bg-gray-100 transition-colors"
                                    title="View data table">
                                <i class="fas fa-table text-sm"></i>
                            </button>
                            <a href="/industri-gaji/table" target="_blank"
                               class="inline-flex items-center px-3 py-1 border border-gray-300 text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50 transition-colors">
                                <i class="fas fa-external-link-alt mr-1"></i>View All
                            </a>
                        </div>
                    </div>
                </div>
                <div class="p-6">
                    <div class="h-64 relative">
                        <div x-show="loading" class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-90 z-10">
                            <div class="text-center">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 mx-auto mb-2"></div>
                                <div class="text-sm text-gray-500">Loading salary data...</div>
                            </div>
                        </div>
                        <div x-show="!dataLoaded && !loading" class="absolute inset-0 flex items-center justify-center text-gray-400">
                            <div class="text-center">
                                <i class="fas fa-dollar-sign text-3xl mb-2"></i>
                                <div class="text-sm">No salary data available</div>
                            </div>
                        </div>
                        <canvas id="salaryChart" class="w-full h-full"></canvas>
                    </div>
                    <div class="mt-4 px-2 text-xs text-gray-500 border-t pt-4">
                        <div class="grid grid-cols-3 gap-2">
                            <div><span class="font-medium">Entry Level:</span> RM 2,000-3,500</div>
                            <div><span class="font-medium">Mid Level:</span> RM 3,500-6,000</div>
                            <div><span class="font-medium">Senior Level:</span> RM 6,000+</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Job Finding Factors -->
            <div class="bg-white rounded-lg border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-medium text-gray-900">Job Finding Methods by Salary</h3>
                            <p class="text-sm text-gray-500">How job finding methods correlate with salary ranges</p>
                        </div>
                        <div class="flex space-x-2">
                            <button @click="openTableModal('Job Finding Factors')" 
                                    class="p-2 text-gray-400 hover:text-gray-600 rounded-md hover:bg-gray-100 transition-colors"
                                    title="View data table">
                                <i class="fas fa-table text-sm"></i>
                            </button>
                            <button @click="refreshChart('jobFactors')" 
                                    class="p-2 text-gray-400 hover:text-gray-600 rounded-md hover:bg-gray-100 transition-colors"
                                    title="Refresh chart">
                                <i class="fas fa-refresh text-sm"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="p-6">
                    <div class="h-64 relative">
                        <div x-show="loading" class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-90 z-10">
                            <div class="text-center">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 mx-auto mb-2"></div>
                                <div class="text-sm text-gray-500">Loading job finding data...</div>
                            </div>
                        </div>
                        <div x-show="!dataLoaded && !loading" class="absolute inset-0 flex items-center justify-center text-gray-400">
                            <div class="text-center">
                                <i class="fas fa-search text-3xl mb-2"></i>
                                <div class="text-sm">No job finding data available</div>
                            </div>
                        </div>
                        <canvas id="jobFactorsChart" class="w-full h-full"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Initialize global charts object
    window.globalCharts = window.globalCharts || {};
    
    // Global safe destroy chart function
    function safeDestroyChart(chartName) {
        try {
            if (window.globalCharts && window.globalCharts[chartName]) {
                window.globalCharts[chartName].destroy();
                delete window.globalCharts[chartName];
            }
        } catch (error) {
            console.error(`Error destroying chart ${chartName}:`, error);
        }
    }
    
    // Global toast function if not available
    function showToast(message, type = 'info') {
        if (typeof showToast !== 'undefined') {
            showToast(message, type);
        } else {
            console.log(`${type.toUpperCase()}: ${message}`);
        }
    }
    
    // Global modal function if not available 
    function openModal(title, url) {
        if (typeof openModal !== 'undefined') {
            openModal(title, url);
        } else {
            console.log(`Opening modal: ${title} - ${url}`);
        }
    }

    function industriGajiDashboard() {
        return {
            loading: false,
            dataLoaded: false,
            kpis: {},
            isInitialized: false,
            filters: {
                graduation_year: [],
                gender: [],
                employment_status: [],
                job_type: []
            },
            availableFilters: {},
            activeFiltersCount: 0,
            
            init() {
                console.log('Initializing employment analytics dashboard...');
                if (this.isInitialized) return;
                this.isInitialized = true;
                this.waitForChart();
                this.loadAvailableFilters();
            },
            
            waitForChart() {
                if (typeof Chart === 'undefined') {
                    setTimeout(() => this.waitForChart(), 100);
                    return;
                }
                this.loadData();
            },
            
            async loadAvailableFilters() {
                try {
                    const response = await fetch('/industri-gaji/api/filters/available');
                    const data = await response.json();
                    
                    this.availableFilters = {
                        graduation_years: data['Tahun graduasi anda?'] || [],
                        genders: data['Jantina anda?'] || [],
                        employment_status: data['Adakah anda kini bekerja?'] || [],
                        job_types: data['Apakah jenis pekerjaan anda sekarang'] || []
                    };
                } catch (error) {
                    console.error('Error loading filters:', error);
                }
            },
            
            async loadData() {
                if (this.loading) return;
                
                this.loading = true;
                
                try {
                    await this.loadSummary();
                    await this.delay(200);
                    await this.loadEmploymentStatus();
                    await this.delay(200);
                    await this.loadJobTypes();
                    await this.delay(200);
                    await this.loadSalaryDistribution();
                    await this.delay(200);
                    await this.loadJobFindingFactors();
                    
                    this.dataLoaded = true;
                } catch (error) {
                    console.error('Error loading data:', error);
                    showToast('Error loading data: ' + error.message, 'error');
                } finally {
                    this.loading = false;
                }
            },
            
            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            },
            
            async loadSummary() {
                try {
                    const params = this.buildFilterParams();
                    const response = await fetch(`/industri-gaji/api/summary?${params}`);
                    if (!response.ok) throw new Error('Failed to load summary');
                    this.kpis = await response.json();
                } catch (error) {
                    console.error('Error loading summary:', error);
                    this.kpis = { 
                        total_records: 0, 
                        full_time_employment_rate: 0, 
                        private_sector_rate: 0, 
                        quick_employment_rate: 0 
                    };
                }
            },
            
            async loadEmploymentStatus() {
                try {
                    const params = this.buildFilterParams();
                    const response = await fetch(`/industri-gaji/api/employment-status?${params}`);
                    const data = await response.json();
                    
                    this.destroyChart('employment');
                    
                    const canvas = document.getElementById('employmentChart');
                    if (canvas) {
                        const ctx = canvas.getContext('2d');
                        if (ctx) {
                            window.globalCharts = window.globalCharts || {};
                            window.globalCharts.employment = new Chart(ctx, {
                                type: 'doughnut',
                                data: data,
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: {
                                            position: 'top',
                                            labels: {
                                                color: '#4A5568',
                                                font: {
                                                    size: 14
                                                }
                                            }
                                        },
                                        tooltip: {
                                            callbacks: {
                                                label: (context) => {
                                                    const label = context.label || '';
                                                    const value = context.raw || 0;
                                                    return `${label}: ${value} (${((value / this.kpis.total_records) * 100).toFixed(2)}%)`;
                                                }
                                            }
                                        }
                                    }
                     }
                            });
                        }
                    }
                } catch (error) {
                    console.error('Error loading employment status:', error);
                }
            },
            
            async loadJobTypes() {
                try {
                    const params = this.buildFilterParams();
                    const response = await fetch(`/industri-gaji/api/job-types?${params}`);
                    const data = await response.json();
                    
                    this.destroyChart('jobTypes');
                    
                    const canvas = document.getElementById('jobTypesChart');
                    if (canvas) {
                        const ctx = canvas.getContext('2d');
                        if (ctx) {
                            window.globalCharts = window.globalCharts || {};
                            window.globalCharts.jobTypes = new Chart(ctx, {
                                type: 'bar',
                                data: data,
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    indexAxis: 'y',
                                    plugins: {
                                        legend: {
                                            display: false
                                        },
                                        tooltip: {
                                            callbacks: {
                                                label: (context) => {
                                                    const label = context.label || '';
                                                    const value = context.raw || 0;
                                                    return `${label}: ${value} positions`;
                                                }
                                            }
                                        }
                                    },
                                    scales: {
                                        x: {
                                            beginAtZero: true,
                                            grid: {
                                                color: '#E2E8F0'
                                            },
                                            ticks: {
                                                color: '#718096'
                                            }
                                        },
                                        y: {
                                            grid: {
                                                display: false
                                            },
                                            ticks: {
                                                color: '#718096',
                                                font: {
                                                    size: 12
                                                }
                                            }
                                        }
                                    }
                                }
                            });
                        }
                    }
                } catch (error) {
                    console.error('Error loading job types:', error);
                }
            },
            
            async loadSalaryDistribution() {
                try {
                    const params = this.buildFilterParams();
                    const response = await fetch(`/industri-gaji/api/salary-distribution?${params}`);
                    const data = await response.json();
                    
                    this.destroyChart('salary');
                    
                    const canvas = document.getElementById('salaryChart');
                    if (canvas) {
                        const ctx = canvas.getContext('2d');
                        if (ctx) {
                            window.globalCharts = window.globalCharts || {};
                            window.globalCharts.salary = new Chart(ctx, {
                                type: 'line',
                                data: data,
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: {
                                            position: 'top',
                                            labels: {
                                                color: '#4A5568',
                                                font: {
                                                    size: 12
                                                }
                                            }
                                        },
                                        tooltip: {
                                            mode: 'index',
                                            intersect: false,
                                            callbacks: {
                                                label: (context) => {
                                                    const label = context.dataset.label || '';
                                                    const value = context.raw || 0;
                                                    return `${label}: RM ${value.toLocaleString()}`;
                                                }
                                            }
                                        }
                                    },
                                    scales: {
                                        x: {
                                            grid: {
                                                color: '#E2E8F0'
                                            },
                                            ticks: {
                                                color: '#718096'
                                            }
                                        },
                                        y: {
                                            beginAtZero: true,
                                            grid: {
                                                color: '#E2E8F0'
                                            },
                                            ticks: {
                                                color: '#718096',
                                                callback: function(value) {
                                                    return 'RM ' + value.toLocaleString();
                                                }
                                            }
                                        }
                                    },
                                    interaction: {
                                        mode: 'nearest',
                                        axis: 'x',
                                        intersect: false
                                    }
                                }
                            });
                        }
                    }
                } catch (error) {
                    console.error('Error loading salary distribution:', error);
                }
            },
            
            async loadJobFindingFactors() {
                try {
                    const params = this.buildFilterParams();
                    const response = await fetch(`/industri-gaji/api/job-finding-factors?${params}`);
                    const data = await response.json();
                    
                    this.destroyChart('jobFactors');
                    
                    const canvas = document.getElementById('jobFactorsChart');
                    if (canvas) {
                        const ctx = canvas.getContext('2d');
                        if (ctx) {
                            window.globalCharts = window.globalCharts || {};
                            window.globalCharts.jobFactors = new Chart(ctx, {
                                type: 'bar',
                                data: data,
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: {
                                            position: 'top',
                                            labels: {
                                                color: '#4A5568',
                                                font: {
                                                    size: 12
                                                }
                                            }
                                        },
                                        tooltip: {
                                            mode: 'index',
                                            intersect: false,
                                            callbacks: {
                                                label: (context) => {
                                                    const label = context.dataset.label || '';
                                                    const value = context.raw || 0;
                                                    return `${label}: RM ${value.toLocaleString()}`;
                                                }
                                            }
                                        }
                                    },
                                    scales: {
                                        x: {
                                            grid: {
                                                color: '#E2E8F0'
                                            },
                                            ticks: {
                                                color: '#718096',
                                                maxRotation: 45,
                                                font: {
                                                    size: 11
                                                }
                                            }
                                        },
                                        y: {
                                            beginAtZero: true,
                                            grid: {
                                                color: '#E2E8F0'
                                            },
                                            ticks: {
                                                color: '#718096',
                                                callback: function(value) {
                                                    return 'RM ' + value.toLocaleString();
                                                }
                                            }
                                        }
                                    },
                                    interaction: {
                                        mode: 'nearest',
                                        axis: 'x',
                                        intersect: false
                                    }
                                }
                            });
                        }
                    }
                } catch (error) {
                    console.error('Error loading job finding factors:', error);
                }
            },
            
            destroyChart(chartName) {
                safeDestroyChart(chartName);
            },
            
            buildFilterParams() {
                const params = new URLSearchParams();
                
                // Add filters to params
                if (this.filters.graduation_year.length > 0) {
                    params.append('graduation_year', this.filters.graduation_year.join(','));
                }
                if (this.filters.gender.length > 0) {
                    params.append('gender', this.filters.gender.join(','));
                }
                if (this.filters.employment_status.length > 0) {
                    params.append('employment_status', this.filters.employment_status.join(','));
                }
                if (this.filters.job_type.length > 0) {
                    params.append('job_type', this.filters.job_type.join(','));
                }
                
                return params.toString();
            },
            
            updateActiveFiltersCount() {
                this.activeFiltersCount = 
                    this.filters.graduation_year.length +
                    this.filters.gender.length +
                    this.filters.employment_status.length +
                    this.filters.job_type.length;
            },
            
            applyFilters() {
                this.updateActiveFiltersCount();
                this.loadData();
                showToast('Filters applied successfully', 'success');
            },
            
            clearAllFilters() {
                this.filters = {
                    graduation_year: [],
                    gender: [],
                    employment_status: [],
                    job_type: []
                };
                this.activeFiltersCount = 0;
                this.loadData();
                showToast('All filters cleared', 'info');
            },
            
            async refreshData() {
                if (this.loading) return;
                
                showToast('Refreshing data...', 'info');
                await this.loadData();
                showToast('Data refreshed successfully', 'success');
            },
            
            async refreshChart(chartType) {
                if (this.loading) return;
                
                this.loading = true;
                
                try {
                    switch(chartType) {
                        case 'employment':
                            await this.loadEmploymentStatus();
                            break;
                        case 'jobTypes':
                            await this.loadJobTypes();
                            break;
                        case 'salary':
                            await this.loadSalaryDistribution();
                            break;
                        case 'jobFactors':
                            await this.loadJobFindingFactors();
                            break;
                        default:
                            console.warn('Unknown chart type:', chartType);
                    }
                    showToast(`${chartType} chart refreshed`, 'success');
                } catch (error) {
                    console.error(`Error refreshing ${chartType}:`, error);
                    showToast(`Error refreshing ${chartType}`, 'error');
                } finally {
                    this.loading = false;
                }
            },
            
            openTableModal(title) {
                const urlMap = {
                    'Employment Status': '/industri-gaji/api/employment-status/table',
                    'Job Types': '/industri-gaji/api/job-types/table',
                    'Salary Distribution': '/industri-gaji/api/salary-distribution/table',
                    'Job Finding Factors': '/industri-gaji/api/job-finding-factors/table'
                };
                
                const url = urlMap[title];
                if (url) {
                    const params = this.buildFilterParams();
                    const fullUrl = params ? `${url}?${params}` : url;
                    openModal(title, fullUrl);
                } else {
                    showToast('Table view not available for this chart', 'warning');
                }
            },
            
            async exportData(format) {
                if (this.loading) return;
                
                try {
                    const params = this.buildFilterParams();
                    const url = `/industri-gaji/api/export/${format}?${params}`;
                    
                    showToast(`Preparing ${format.toUpperCase()} export...`, 'info');
                    
                    // Create a temporary link to trigger download
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `employment_analytics_${new Date().toISOString().split('T')[0]}.${format}`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showToast(`${format.toUpperCase()} export completed`, 'success');
                } catch (error) {
                    console.error('Export error:', error);
                    showToast(`Export failed: ${error.message}`, 'error');
                }
            },
            
            // Cleanup function
            destroy() {
                const chartNames = ['employment', 'jobTypes', 'salary', 'jobFactors'];
                chartNames.forEach(chartName => {
                    this.destroyChart(chartName);
                });
                this.isInitialized = false;
            }
        };
    }
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        if (window.globalCharts) {
            Object.keys(window.globalCharts).forEach(chartName => {
                safeDestroyChart(chartName);
            });
        }
    });
    
    // Handle visibility change to pause/resume updates
    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
            // Resume any background processes if needed
            console.log('Page visible - resuming dashboard');
        } else {
            // Pause any background processes if needed
            console.log('Page hidden - pausing dashboard');
        }
    });
</script>
{% endblock %}