{% extends "base.html" %}

{% block content %}
<div x-data="gigEconomyDashboard()" x-init="init()"
    class="px-6 space-y-6 pb-6 bg-gradient-to-br from-gray-50 to-blue-50/30 min-h-screen">

    <div class="relative">
        <div class="flex flex-row border-b border-gray-300 justify-between py-4 -mx-6">

            <!-- Logo -->
            <div class="px-4 space-x-4 flex flex-row items-center">
                <img src="{{ url_for('static', filename='img/1. UPTM.png') }}" alt="Logo UPTM"
                    style="width: auto; height: 30px;">
                <img src="{{ url_for('static', filename='img/2.MARA 2.png') }}" alt="Logo MARA"
                    style="width: auto; height: 30px;">
                <img src="{{ url_for('static', filename='img/3.KKWK.png') }}" alt="Logo KKWK"
                    style="width: auto; height: 30px;">
                <img src="{{ url_for('static', filename='img/4.KPTM.png') }}" alt="Logo KPTM"
                    style="width: auto; height: 30px;">
                <img src="{{ url_for('static', filename='img/5.IKEB.jpg') }}" alt="Logo IKEB"
                    style="width: auto; height: 27px;">
            </div>
            <!-- Button Section -->
            <div class="flex flex-row space-x-4 px-6">
                <!-- Filters -->
                <div class="relative" x-data="{ open: false }">
                    <button @click="open = !open"
                        class="button-style flex items-center px-3 py-1 rounded-md transition-all duration-200 shadow-lg border-[1.5px] border-gray-50 hover:border-primary-400">
                        <i class="fas fa-filter  text-primary-700 text-[10px]"></i>
                        <span class="font-semibold  text-primary-700 text-[10px]">Penapisan</span>
                        <div x-show="activeFiltersCount > 0"
                            class="bg-primary-400 text-white text-xs rounded-full w-6 h-6 flex items-center justify-center font-bold"
                            x-text="activeFiltersCount"></div>
                    </button>

                    <!-- Filter Dropdown -->
                    <div x-show="open" @click.away="open = false" x-transition:enter="transition ease-out duration-200"
                        x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100"
                        class="absolute right-0 mt-2 w-72 bg-white/95 backdrop-blur-sm rounded-xl shadow-2xl border border-white/20 z-50">
                        <div class="p-4">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="text-base font-semibold text-gray-800">Pilihan Penapis</h3>
                                <button @click="clearAllFilters()"
                                    class="text-[#c92427] hover:text-red-700 text-sm font-medium">
                                    <i class="fas fa-times mr-1"></i>Kosongkan
                                </button>
                            </div>

                            <!-- Compact Filter Sections -->
                            <div class="space-y-3">
                                <!-- Year Filter -->
                                <div>
                                    <label class="text-xs font-medium text-gray-700 mb-1 block">
                                        <i class="fas fa-calendar mr-1 text-[#074e7e]"></i>Tahun Graduasi
                                    </label>
                                    <div class="grid grid-cols-4 gap-1 text-xs">
                                        <template x-for="year in availableFilters.graduation_years || []">
                                            <label
                                                class="flex items-center p-1 rounded cursor-pointer hover:bg-blue-50">
                                                <input type="checkbox" :value="year" x-model="filters.graduation_year"
                                                    class="rounded border-gray-300 text-[#074e7e] focus:ring-[#074e7e] text-xs mr-1">
                                                <span class="text-gray-700" x-text="year"></span>
                                            </label>
                                        </template>
                                    </div>
                                </div>

                                <!-- Gender Filter -->
                                <div>
                                    <label class="text-xs font-medium text-gray-700 mb-1 block">
                                        <i class="fas fa-users mr-1 text-[#c92427]"></i>Jantina
                                    </label>
                                    <div class="grid grid-cols-2 gap-1 text-xs">
                                        <template x-for="gender in availableFilters.genders || []">
                                            <label class="flex items-center p-1 rounded cursor-pointer hover:bg-red-50">
                                                <input type="checkbox" :value="gender" x-model="filters.gender"
                                                    class="rounded border-gray-300 text-[#c92427] focus:ring-[#c92427] text-xs mr-1">
                                                <span class="text-gray-700" x-text="gender"></span>
                                            </label>
                                        </template>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-4 pt-3 border-t border-gray-200">
                                <button @click="applyFilters(); open = false"
                                    class="w-full bg-[#074e7e] text-white font-medium py-2 px-3 rounded-lg hover:bg-[#063a5f] transition-colors text-sm">
                                    Tapis
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Export Button -->
                <div class="relative" x-data="{ open: false }">
                    <button @click="open = !open"
                        class="button-style-fulll-blue flex items-center bg-gradient-to-r from-primary-400 to-primary-500 text-white px-3 py-1 rounded-md hover:from-primary-500 hover:to-primary-700 transition-all duration-200 shadow-lg shadow-primary-500/30">
                        <i class="fas fa-download text-[10px]"></i>
                        <span class="font-semibold text-[10px] ml-1">Eksport</span>
                    </button>

                    <div x-show="open" @click.away="open = false" x-transition
                        class="absolute right-0 mt-3 w-56 bg-white/95 backdrop-blur-sm rounded-xl shadow-2xl border border-white/20 z-50">
                        <div class="py-3">
                            <button @click="exportData('csv'); open = false"
                                class="w-full text-left px-6 py-3 text-sm hover:bg-emerald-50 flex items-center space-x-3 transition-colors">
                                <i class="fas fa-file-csv text-emerald-600 text-lg"></i>
                                <div>
                                    <div class="font-semibold text-gray-900">CSV Format</div>
                                    <div class="text-xs text-gray-500">Comma-separated values</div>
                                </div>
                            </button>
                            <button @click="exportData('excel'); open = false"
                                class="w-full text-left px-6 py-3 text-sm hover:bg-blue-50 flex items-center space-x-3 transition-colors">
                                <i class="fas fa-file-excel text-blue-600 text-lg"></i>
                                <div>
                                    <div class="font-semibold text-gray-900">Excel Format</div>
                                    <div class="text-xs text-gray-500">Microsoft Excel file</div>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Refresh Button -->
                <div>
                    <button @click="refreshData()"
                        class="button-style flex items-center px-3 py-1 rounded-md transition-all duration-200 shadow-lg border-[1.5px] border-gray-50 hover:border-primary-400"
                        :disabled="loading">
                        <i class="fas fa-sync-alt text-primary-700 text-[10px]"
                            :class="{ 'animate-spin': loading }"></i>
                        <span class="text-[10px] text-primary-700 font-semibold">Muat Semula</span>
                    </button>
                </div>

            </div>

        </div>
    </div>

    <!-- Minimal Corporate Header -->
    <div
        class="blue-gradient rounded-2xl p-6 lg:p-8 shadow-xl border border-blue-800/10">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-4 lg:space-y-0">
            <div class="flex items-center space-x-4">
                <div
                    class="w-16 h-16 bg-gradient-to-br from-secondary-400 via-secondary-500 to-secondary-900 rounded-full flex items-center justify-center shadow-lg ring-4 ring-white/20">
                    <i class="fas fa-chart-line text-white text-lg"></i>
                </div>
                <div>
                    <h1 class="text-2xl lg:text-3xl font-bold text-white mb-1">
                        Trend Ekonomi Gig & Keusahawanan
                    </h1>
                    <p class="text-blue-100 text-sm lg:text-base">Analisis menyeluruh mengenai pilihan kerja bebas dan
                        aktiviti keusahawanan</p>
                    <div class="flex items-center mt-2 space-x-4 text-xs">
                        <div class="flex items-center space-x-1">
                            <div class="w-2 h-2 bg-emerald-400 rounded-full animate-pulse"></div>
                            <span class="text-emerald-200 font-medium">Analisis Langsung</span>
                        </div>
                        <div class="text-blue-200">
                            <span x-show="dataLoaded">
                                <i class="fas fa-users mr-1"></i>
                                <span x-text="kpis.total_records || 0"></span> Responden
                            </span>
                            <span x-show="loading">
                                <i class="fas fa-spinner fa-spin mr-1"></i>
                                Menganalisis...
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Minimal KPI Strip -->
    <div class="grid grid-cols-2 lg:grid-cols-6 gap-3 lg:gap-4">
        <div
            class="bg-white/80 backdrop-blur-sm rounded-xl p-3 lg:p-4 shadow-md border border-gray-200/50 hover:shadow-lg transition-all">
            <div class="flex flex-row items-start space-x-2">
                <div class="w-8 h-8 bg-blue-50 rounded-lg flex items-center justify-center shrink-0">
                    <i class="fas fa-users text-[#074e7e] text-sm"></i>
                </div>
                <div>
                    <div class="text-lg lg:text-xl font-bold text-gray-800" x-text="kpis.total_records || '0'"></div>
                    <div class="text-xs text-gray-500">Jumlah Responden</div>
                </div>
            </div>
        </div>

        <div
            class="bg-white/80 backdrop-blur-sm rounded-xl p-3 lg:p-4 shadow-md border border-gray-200/50 hover:shadow-lg transition-all">
            <div class="flex flex-row items-start space-x-2">
                <div class="w-8 h-8 bg-red-50 rounded-lg flex items-center justify-center shrink-0">
                    <i class="fas fa-briefcase text-[#c92427] text-sm"></i>
                </div>
                <div>
                    <div class="text-lg lg:text-xl font-bold text-gray-800"
                        x-text="(kpis.gig_participation_rate || 0) + '%'"></div>
                    <div class="text-xs text-gray-500">Kerja Gig</div>
                </div>
            </div>
        </div>

        <div
            class="bg-white/80 backdrop-blur-sm rounded-xl p-3 lg:p-4 shadow-md border border-gray-200/50 hover:shadow-lg transition-all">
            <div class="flex flex-row items-start space-x-2">
                <div class="w-8 h-8 bg-green-50 rounded-lg flex items-center justify-center shrink-0">
                    <i class="fas fa-rocket text-green-600 text-sm"></i>
                </div>
                <div>
                    <div class="text-lg lg:text-xl font-bold text-gray-800"
                        x-text="(kpis.entrepreneurship_rate || 0) + '%'"></div>
                    <div class="text-xs text-gray-500">Usahawan</div>
                </div>
            </div>
        </div>

        <div
            class="bg-white/80 backdrop-blur-sm rounded-xl p-3 lg:p-4 shadow-md border border-gray-200/50 hover:shadow-lg transition-all">
            <div class="flex flex-row items-start space-x-2">
                <div class="w-8 h-8 bg-purple-50 rounded-lg flex items-center justify-center shrink-0">
                    <i class="fas fa-graduation-cap text-purple-600 text-sm"></i>
                </div>
                <div>
                    <div class="text-lg lg:text-xl font-bold text-gray-800"
                        x-text="(kpis.university_support_rate || 0) + '%'"></div>
                    <div class="text-xs text-gray-500">Sokongan Uni</div>
                </div>
            </div>
        </div>

        <div
            class="bg-white/80 backdrop-blur-sm rounded-xl p-3 lg:p-4 shadow-md border border-gray-200/50 hover:shadow-lg transition-all">
            <div class="flex flex-row items-start space-x-2">
                <div class="w-8 h-8 bg-amber-50 rounded-lg flex items-center justify-center shrink-0">
                    <i class="fas fa-dollar-sign text-amber-600 text-sm"></i>
                </div>
                <div>
                    <div class="text-lg lg:text-xl font-bold text-gray-800" x-text="kpis.avg_income || 'RM0'"></div>
                    <div class="text-xs text-gray-500">Purata Pendapatan</div>
                </div>
            </div>
        </div>

        <div
            class="bg-white/80 backdrop-blur-sm rounded-xl p-3 lg:p-4 shadow-md border border-gray-200/50 hover:shadow-lg transition-all">
            <div class="flex flex-row items-start space-x-2">
                <div class="w-8 h-8 bg-indigo-50 rounded-lg flex items-center justify-center shrink-0">
                    <i class="fas fa-chart-line text-indigo-600 text-sm"></i>
                </div>
                <div>
                    <div class="text-lg lg:text-xl font-bold text-gray-800"
                        x-text="(kpis.job_preference_rate || 0) + '%'"></div>
                    <div class="text-xs text-gray-500">Pilih Kerja Tetap</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Professional Bento Grid Layout for Charts -->
    <div class="grid grid-cols-12 gap-4 lg:gap-6">
        <!-- Row 1: 2 Charts - Jenis Kerja Ekonomi Gig & Motivasi Ekonomi Gig -->
        <!-- Jenis Kerja Ekonomi Gig (6 cols) -->
        <div
            class="col-span-12 lg:col-span-6 bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl border border-gray-200/60 overflow-hidden">
            <div class="blue-gradient px-4 py-3">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-md font-bold text-white">Jenis Kerja Ekonomi Gig</h3>
                        <p class="text-white text-xs mt-1">Aktiviti kerja bebas semasa dan yang dirancang</p>
                    </div>
                    <div class="flex space-x-1">
                        <div class="relative group">
                            <button @click="openTableModal('Gig Types')"
                                class="p-1 w-8 h-8 bg-white/20 rounded hover:bg-white/30 transition-colors">
                                <i class="fas fa-table text-white text-xs"></i>
                            </button>
                            <div
                                class="absolute left-1/2 -translate-x-1/2 mt-1 opacity-0 group-hover:opacity-100 
                                bg-black/70 text-white text-[8px] px-2 py-1 rounded z-50 pointer-events-none transition whitespace-nowrap">
                                Maklumat Lanjut
                            </div>
                        </div>
                        <div class="relative group">
                            <button @click="refreshChart('gigTypes')"
                                class="p-1 w-8 h-8 bg-white/20 rounded hover:bg-white/30 transition-colors">
                                <i class="fas fa-refresh text-white text-xs"></i>
                            </button>
                            <div
                                class="absolute left-1/2 -translate-x-1/2 mt-1 opacity-0 group-hover:opacity-100 
                                bg-black/70 text-white text-[8px] px-2 py-1 rounded z-50 pointer-events-none transition whitespace-nowrap">
                                Muat Semula
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4">
                <div class="h-48 relative">
                    <div x-show="loading"
                        class="absolute inset-0 flex items-center justify-center bg-white/90 backdrop-blur-sm z-10">
                        <div class="text-center">
                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-[#074e7e] mx-auto mb-2">
                            </div>
                            <div class="text-gray-600 text-xs">Memuatkan jenis kerja...</div>
                        </div>
                    </div>
                    <canvas id="gigTypesChart" class="w-full h-full"></canvas>
                </div>
            </div>
        </div>

        <!-- Motivasi Ekonomi Gig (6 cols) -->
        <div
            class="col-span-12 lg:col-span-6 bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl border border-gray-200/60 overflow-hidden">
            <div class="red-gradient px-4 py-3">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-md font-bold text-white">Motivasi Ekonomi Gig</h3>
                        <p class="text-white text-xs mt-1">Sebab utama memilih kerja bebas</p>
                    </div>
                    <div class="flex space-x-1">
                        <div class="relative group">

                            <button @click="openTableModal('Motivations Analysis')"
                                class="p-1 w-8 h-8 bg-white/20 rounded hover:bg-white/30 transition-colors text-white text-xs">
                                <i class="fas fa-table"></i>
                            </button>
                            <div
                                class="absolute left-1/2 -translate-x-1/2 mt-1 opacity-0 group-hover:opacity-100 
                                bg-black/70 text-white text-[8px] px-2 py-1 rounded z-50 pointer-events-none transition whitespace-nowrap">
                                Maklumat Lanjut
                            </div>
                        </div>

                        <div class="relative group">
                            <button @click="refreshChart('gigMotivations')"
                                class="p-1 w-8 h-8 bg-white/20 rounded hover:bg-white/30 transition-colors">
                                <i class="fas fa-refresh text-white text-xs"></i>
                            </button>
                            <div
                                class="absolute left-1/2 -translate-x-1/2 mt-1 opacity-0 group-hover:opacity-100 
                                bg-black/70 text-white text-[8px] px-2 py-1 rounded z-50 pointer-events-none transition whitespace-nowrap">
                                Muat Semula
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4">
                <div class="h-48 relative">
                    <div x-show="loading"
                        class="absolute inset-0 flex items-center justify-center bg-white/90 backdrop-blur-sm z-10">
                        <div class="text-center">
                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-indigo-600 mx-auto mb-2">
                            </div>
                            <div class="text-gray-600 text-xs">Menganalisis motivasi...</div>
                        </div>
                    </div>
                    <canvas id="gigMotivationsChart" class="w-full h-full"></canvas>
                </div>
            </div>
        </div>

        <!-- Row 2: 3 Charts - Sokongan Universiti, Program Universiti, Impak Program -->
        <!-- Sokongan Universiti (4 cols) -->
        <div
            class="col-span-12 lg:col-span-4 bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl border border-gray-200/60 overflow-hidden">
            <div class="blue-gradient px-4 py-3">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-md font-bold text-white">Sokongan Universiti</h3>
                        <p class="text-white text-xs mt-1">Kursus Keusahawanan</p>
                    </div>
                    <div class="relative group">
                        <button @click="refreshChart('universitySupport')"
                            class="p-1 w-8 h-8 bg-white/20 rounded hover:bg-white/30 transition-colors">
                            <i class="fas fa-refresh text-white text-xs"></i>
                        </button>
                        <div
                            class="absolute left-1/2 -translate-x-1/2 mt-1 opacity-0 group-hover:opacity-100 
                                bg-black/70 text-white text-[8px] px-2 py-1 rounded z-50 pointer-events-none transition whitespace-nowrap">
                            Muat Semula
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4">
                <div class="h-48 relative">
                    <div x-show="loading" class="absolute inset-0 flex items-center justify-center bg-white/90">
                        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-[#c92427]"></div>
                    </div>
                    <canvas id="universitySupportChart" class="w-full h-full"></canvas>
                </div>
            </div>
        </div>

        <!-- Program Universiti (4 cols) -->
        <div
            class="col-span-12 lg:col-span-4 bg-white/95 backdrop-blur-sm rounded-2xl shadow-lg border border-gray-200/60 overflow-hidden">
            <div class="purple-gradient px-4 py-3">
                <div class="flex items-center justify-between">
                    <div>

                        <h3 class="text-md font-semibold text-white">Program Universiti</h3>
                        <p class="text-white text-xs mt-1">Inisiatif perniagaan & ekonomi gig</p>
                    </div>
                    <div class="relative group">
                        <button @click="openTableModal('Programs')"
                            class="p-1 w-8 h-8 bg-white/20 rounded hover:bg-white/30 transition-colors">
                            <i class="fas fa-external-link-alt text-white text-xs"></i>
                        </button>
                        <div
                            class="absolute left-1/2 -translate-x-1/2 mt-1 opacity-0 group-hover:opacity-100 
                                bg-black/70 text-white text-[8px] px-2 py-1 rounded z-50 pointer-events-none transition whitespace-nowrap">
                            Buka Halaman
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4">
                <div class="h-48 relative">
                    <div x-show="loading" class="absolute inset-0 flex items-center justify-center bg-white/90">
                        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-slate-700"></div>
                    </div>
                    <canvas id="universityProgramsChart" class="w-full h-full"></canvas>
                </div>
            </div>
        </div>

        <!-- Impak Program (4 cols) -->
        <div
            class="col-span-12 lg:col-span-4 bg-white/95 backdrop-blur-sm rounded-2xl shadow-lg border border-gray-200/60 overflow-hidden">
            <div class="red-gradient px-4 py-3">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-md font-semibold text-white">Impak Program</h3>
                        <p class="text-white text-xs mt-1">Bagaimana program membantu pelajar</p>
                    </div>
                    <div class="relative group">

                        <button @click="refreshChart('programEffectiveness')"
                            class="p-1 w-8 h-8 bg-white/20 rounded hover:bg-white/30 transition-colors">
                            <i class="fas fa-refresh text-white text-xs"></i>
                        </button>
                        <div
                            class="absolute left-1/2 -translate-x-1/2 mt-1 opacity-0 group-hover:opacity-100 
                                bg-black/70 text-white text-[8px] px-2 py-1 rounded z-50 pointer-events-none transition whitespace-nowrap">
                            Muat Semula
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4">
                <div class="h-48 relative">
                    <div x-show="loading" class="absolute inset-0 flex items-center justify-center bg-white/90">
                        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-emerald-600"></div>
                    </div>
                    <canvas id="programEffectivenessChart" class="w-full h-full"></canvas>
                </div>
            </div>
        </div>

        <!-- Row 3: 2 Charts - Sokongan & Bantuan Diperlukan, Cabaran Utama -->
        <!-- Sokongan & Bantuan Diperlukan (6 cols) -->
        <div
            class="col-span-12 lg:col-span-6 bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl border border-gray-200/60 overflow-hidden">
            <div class="purple-gradient px-4 py-3">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-md font-semibold text-white">Sokongan & Bantuan Diperlukan</h3>
                        <p class="text-white text-xs mt-1">Apa yang usahawan perlukan untuk berjaya</p>
                    </div>
                    <div class="relative group">
                        <button @click="openTableModal('Support Analysis')"
                            class="p-1 w-8 h-8 bg-white/20 rounded hover:bg-white/30 transition-colors text-white text-xs">
                            <i class="fas fa-external-link-alt"></i>
                        </button>
                        <div
                            class="absolute left-1/2 -translate-x-1/2 mt-1 opacity-0 group-hover:opacity-100 
                                bg-black/70 text-white text-[8px] px-2 py-1 rounded z-50 pointer-events-none transition whitespace-nowrap">
                            Buka Halaman
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4">
                <div class="h-48 relative">
                    <div x-show="loading" class="absolute inset-0 flex items-center justify-center bg-white/90">
                        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-amber-600"></div>
                    </div>
                    <canvas id="supportNeededChart" class="w-full h-full"></canvas>
                </div>
            </div>
        </div>

        <!-- Cabaran Utama (6 cols) -->
        <div
            class="col-span-12 lg:col-span-6 bg-white/95 backdrop-blur-sm rounded-2xl shadow-lg border border-gray-200/60 overflow-hidden">
            <div class="blue-purple-gradient px-4 py-3">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-md font-semibold text-white">Cabaran Utama</h3>
                        <p class="text-white text-xs mt-1">Halangan dalam ekonomi gig</p>
                    </div>
                    <div class="relative group">
                        <button @click="openTableModal('Challenges')"
                            class="p-1 w-8 h-8 bg-white/20 rounded hover:bg-white/30 transition-colors">
                            <i class="fas fa-table text-white text-xs"></i>
                        </button>
                         <div
                            class="absolute left-1/2 -translate-x-1/2 mt-1 opacity-0 group-hover:opacity-100 
                                bg-black/70 text-white text-[8px] px-2 py-1 rounded z-50 pointer-events-none transition whitespace-nowrap">
                            Maklumat Lanjut
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4">
                <div class="h-48 relative">
                    <div x-show="loading" class="absolute inset-0 flex items-center justify-center bg-white/90">
                        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-red-500"></div>
                    </div>
                    <canvas id="gigChallengesChart" class="w-full h-full"></canvas>
                </div>
            </div>
        </div>

        <!-- Row 4: 3 Charts - Kaedah Pemerolehan Kemahiran, Pendapatan Bulanan, Pilihan Kerjaya -->
        <!-- Kaedah Pemerolehan Kemahiran (4 cols) -->
        <div
            class="col-span-12 lg:col-span-4 bg-white/95 backdrop-blur-sm rounded-2xl shadow-lg border border-gray-200/60 overflow-hidden">
            <div class="red-gradient px-4 py-3">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-md font-semibold text-white">Kaedah Pemerolehan Kemahiran</h3>
                        <p class="text-white text-xs mt-1">Bagaimana pekerja mempelajari kemahiran</p>
                    </div>
                    <div class="relative group">
                        <button @click="refreshChart('skillAcquisition')"
                            class="p-1 w-8 h-8 bg-white/20 rounded hover:bg-white/30 transition-colors">
                            <i class="fas fa-refresh text-white text-xs"></i>
                        </button>
                         <div
                            class="absolute left-1/2 -translate-x-1/2 mt-1 opacity-0 group-hover:opacity-100 
                                bg-black/70 text-white text-[8px] px-2 py-1 rounded z-50 pointer-events-none transition whitespace-nowrap">
                            Muat Semula
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4">
                <div class="h-48 relative">
                    <div x-show="loading" class="absolute inset-0 flex items-center justify-center bg-white/90">
                        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-cyan-600"></div>
                    </div>
                    <canvas id="skillAcquisitionChart" class="w-full h-full"></canvas>
                </div>
            </div>
        </div>

        <!-- Pendapatan Bulanan (4 cols) -->
        <div
            class="col-span-12 lg:col-span-4 bg-white/95 backdrop-blur-sm rounded-2xl shadow-lg border border-gray-200/60 overflow-hidden">
            <div class="purple-gradient px-4 py-3">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-md font-bold text-white">Pendapatan Bulanan</h3>
                        <p class="text-white text-xs mt-1">Pendapatan ekonomi gig</p>
                    </div>
                    <div class="relative group">

                        <button @click="refreshChart('monthlyIncome')"
                            class="p-1 w-8 h-8 bg-white/20 rounded hover:bg-white/30 transition-colors">
                            <i class="fas fa-refresh text-white text-xs"></i>
                        </button>
                        <div
                            class="absolute left-1/2 -translate-x-1/2 mt-1 opacity-0 group-hover:opacity-100 
                                bg-black/70 text-white text-[8px] px-2 py-1 rounded z-50 pointer-events-none transition whitespace-nowrap">
                            Muat Semula
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4">
                <div class="h-48 relative">
                    <div x-show="loading" class="absolute inset-0 flex items-center justify-center bg-white/90">
                        <div class="text-center">
                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-green-600 mx-auto mb-2">
                            </div>
                            <div class="text-gray-600 text-xs">Memuatkan data pendapatan...</div>
                        </div>
                    </div>
                    <canvas id="monthlyIncomeChart" class="w-full h-full"></canvas>
                </div>
            </div>
        </div>

        <!-- Pilihan Kerjaya (4 cols) -->
        <div
            class="col-span-12 lg:col-span-4 bg-white/95 backdrop-blur-sm rounded-2xl shadow-lg border border-gray-200/60 overflow-hidden">
            <div class="blue-gradient px-4 py-3">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-md font-semibold text-white">Pilihan Kerjaya</h3>
                        <p class="text-white text-xs mt-1">Pilihan kerja tetap vs ekonomi gig</p>
                    </div>
                    <div class="relative group">
                        <a href="/gig-economy/table" target="_blank"
                            class="p-1 flex items-center justify-center w-8 h-8 bg-white/20 rounded hover:bg-white/30 transition-colors text-white text-xs">
                            <i class="fas fa-external-link-alt"></i>
                        </a>
                        <div
                            class="absolute left-1/2 -translate-x-1/2 mt-1 opacity-0 group-hover:opacity-100 
                                bg-black/70 text-white text-[8px] px-2 py-1 rounded z-50 pointer-events-none transition whitespace-nowrap">
                            Buka Halaman
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4">
                <div class="h-48 relative">
                    <div x-show="loading" class="absolute inset-0 flex items-center justify-center bg-white/90">
                        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-violet-600"></div>
                    </div>
                    <canvas id="jobPreferenceChart" class="w-full h-full"></canvas>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
function gigEconomyDashboard() {
    return {
        loading: false,
        dataLoaded: false,
        kpis: {},
        isInitialized: false,
        filters: {
            graduation_year: [],
            gender: []
        },
        availableFilters: {},
        activeFiltersCount: 0,
        charts: {}, // Store chart instances

        init() {
            console.log('Initializing gig economy dashboard...');
            if (this.isInitialized) return;
            this.isInitialized = true;
            this.waitForChart();
            this.loadAvailableFilters();
        },

        waitForChart() {
            // Wait for both Chart.js and our centralized config to load
            if (typeof Chart === 'undefined' || 
                typeof EnhancedChartFactory === 'undefined' || 
                typeof ChartConfig === 'undefined') {
                setTimeout(() => this.waitForChart(), 100);
                return;
            }
            console.log('Chart libraries loaded, initializing gig economy dashboard...');
            this.loadData();
        },

        async loadAvailableFilters() {
            try {
                const response = await fetch('/gig-economy/api/filters/available');
                const data = await response.json();

                this.availableFilters = {
                    graduation_years: data['Tahun graduasi anda?'] || [],
                    genders: data['Jantina anda?'] || []
                };
            } catch (error) {
                console.error('Error loading filters:', error);
            }
        },

        async loadData() {
            if (this.loading) return;

            this.loading = true;

            try {
                await this.loadSummary();
                await this.delay(100);
                await this.loadGigTypesChart();
                await this.delay(100);
                await this.loadUniversitySupportChart();
                await this.delay(100);
                await this.loadUniversityProgramsChart();
                await this.delay(100);
                await this.loadProgramEffectivenessChart();
                await this.delay(100);
                await this.loadGigMotivationsChart();
                await this.delay(100);
                await this.loadSkillAcquisitionChart();
                await this.delay(100);
                await this.loadGigChallengesChart();
                await this.delay(100);
                await this.loadSupportNeededChart();
                await this.delay(100);
                await this.loadMonthlyIncomeChart();
                await this.delay(100);
                await this.loadJobPreferenceChart();

                this.dataLoaded = true;
            } catch (error) {
                console.error('Error loading data:', error);
                this.showToast('Error loading data: ' + error.message, 'error');
            } finally {
                this.loading = false;
            }
        },

        delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        },

        async loadSummary() {
            try {
                const params = this.buildFilterParams();
                const response = await fetch(`/gig-economy/api/summary?${params}`);
                if (!response.ok) throw new Error('Failed to load summary');
                this.kpis = await response.json();
            } catch (error) {
                console.error('Error loading summary:', error);
                this.kpis = {
                    total_records: 0,
                    gig_participation_rate: 0,
                    entrepreneurship_rate: 0,
                    university_support_rate: 0,
                    avg_income: 'RM0',
                    job_preference_rate: 0
                };
            }
        },

        async loadGigTypesChart() {
            try {
                const params = this.buildFilterParams();
                const response = await fetch(`/gig-economy/api/gig-types?${params}`);
                const data = await response.json();

                if (this.charts.gigTypes) {
                    this.charts.gigTypes.destroy();
                }

                const canvas = document.getElementById('gigTypesChart');
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    if (ctx) {
                        // Use centralized chart factory with proper text handling
                        this.charts.gigTypes = EnhancedChartFactory.createChart(
                            ctx,
                            'bar',
                            data,
                            'gig-types',
                            {
                                indexAxis: 'y', // Horizontal bar chart
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    x: {
                                        beginAtZero: true,
                                        grid: {
                                            color: 'rgba(0,0,0,0.04)',
                                            drawBorder: false
                                        },
                                        ticks: {
                                            font: { size: 11, weight: '500' },
                                            color: '#6b7280',
                                            callback: function(value) {
                                                return value.toLocaleString();
                                            }
                                        }
                                    },
                                    y: {
                                        grid: { display: false },
                                        ticks: {
                                            font: { size: 10, weight: '500' },
                                            color: '#374151',
                                            maxRotation: 0, // Keep labels horizontal
                                            padding: 8,
                                            callback: function(value, index) {
                                                const label = this.getLabelForValue(value);
                                                // Truncate long labels
                                                return label.length > 20 ? label.substring(0, 17) + '...' : label;
                                            }
                                        }
                                    }
                                },
                                plugins: {
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                return `${context.label}: ${context.parsed.x} responses`;
                                            }
                                        }
                                    }
                                }
                            }
                        );
                    }
                }
            } catch (error) {
                console.error('Error loading gig types chart:', error);
            }
        },

        async loadGigMotivationsChart() {
            try {
                const params = this.buildFilterParams();
                const response = await fetch(`/gig-economy/api/gig-motivations?${params}`);
                const data = await response.json();

                if (this.charts.gigMotivations) {
                    this.charts.gigMotivations.destroy();
                }

                const canvas = document.getElementById('gigMotivationsChart');
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    if (ctx) {
                        this.charts.gigMotivations = EnhancedChartFactory.createChart(
                            ctx,
                            'bar',
                            data,
                            'gig-motivations',
                            {
                                indexAxis: 'y',
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    x: {
                                        beginAtZero: true,
                                        grid: {
                                            color: 'rgba(0,0,0,0.04)',
                                            drawBorder: false
                                        },
                                        ticks: {
                                            font: { size: 11 },
                                            color: '#6b7280',
                                            callback: function(value) {
                                                return value.toLocaleString();
                                            }
                                        }
                                    },
                                    y: {
                                        grid: { display: false },
                                        ticks: {
                                            font: { size: 9, weight: '500' },
                                            color: '#374151',
                                            maxRotation: 0,
                                            padding: 6,
                                            callback: function(value, index) {
                                                const label = this.getLabelForValue(value);
                                                // Truncate very long motivation labels
                                                return label.length > 25 ? label.substring(0, 22) + '...' : label;
                                            }
                                        }
                                    }
                                }
                            }
                        );
                    }
                }
            } catch (error) {
                console.error('Error loading gig motivations chart:', error);
            }
        },

        async loadUniversitySupportChart() {
            try {
                const params = this.buildFilterParams();
                const response = await fetch(`/gig-economy/api/university-support?${params}`);
                const data = await response.json();

                if (this.charts.universitySupport) {
                    this.charts.universitySupport.destroy();
                }

                const canvas = document.getElementById('universitySupportChart');
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    if (ctx) {
                        this.charts.universitySupport = EnhancedChartFactory.createChart(
                            ctx,
                            'pie',
                            data,
                            'university-support',
                            {
                                plugins: {
                                    legend: {
                                        display: true,
                                        position: 'bottom',
                                        labels: {
                                            padding: 15,
                                            font: { size: 10, weight: '500' },
                                            usePointStyle: true
                                        }
                                    }
                                }
                            }
                        );
                    }
                }
            } catch (error) {
                console.error('Error loading university support chart:', error);
            }
        },

        async loadUniversityProgramsChart() {
            try {
                const params = this.buildFilterParams();
                const response = await fetch(`/gig-economy/api/university-programs?${params}`);
                const data = await response.json();

                if (this.charts.universityPrograms) {
                    this.charts.universityPrograms.destroy();
                }

                const canvas = document.getElementById('universityProgramsChart');
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    if (ctx) {
                        this.charts.universityPrograms = EnhancedChartFactory.createChart(
                            ctx,
                            'pie',
                            data,
                            'university-programs',
                            {
                                plugins: {
                                    legend: {
                                        display: true,
                                        position: 'bottom',
                                        labels: {
                                            padding: 12,
                                            font: { size: 9, weight: '500' },
                                            usePointStyle: true,
                                            generateLabels: function(chart) {
                                                const data = chart.data;
                                                if (data.labels.length && data.datasets.length) {
                                                    return data.labels.map((label, index) => {
                                                        const dataset = data.datasets[0];
                                                        const value = dataset.data[index];
                                                        const total = dataset.data.reduce((sum, val) => sum + val, 0);
                                                        const percentage = ((value / total) * 100).toFixed(1);
                                                        
                                                        // Truncate long labels for pie chart legend
                                                        const truncatedLabel = label.length > 15 ? label.substring(0, 12) + '...' : label;
                                                        
                                                        return {
                                                            text: `${truncatedLabel} (${percentage}%)`,
                                                            fillStyle: dataset.backgroundColor[index],
                                                            strokeStyle: dataset.borderColor,
                                                            lineWidth: dataset.borderWidth,
                                                            hidden: false,
                                                            index: index
                                                        };
                                                    });
                                                }
                                                return [];
                                            }
                                        }
                                    }
                                }
                            }
                        );
                    }
                }
            } catch (error) {
                console.error('Error loading university programs chart:', error);
            }
        },

        async loadProgramEffectivenessChart() {
            try {
                const params = this.buildFilterParams();
                const response = await fetch(`/gig-economy/api/program-effectiveness?${params}`);
                const data = await response.json();

                if (this.charts.programEffectiveness) {
                    this.charts.programEffectiveness.destroy();
                }

                const canvas = document.getElementById('programEffectivenessChart');
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    if (ctx) {
                        this.charts.programEffectiveness = EnhancedChartFactory.createChart(
                            ctx,
                            'pie',
                            data,
                            'program-effectiveness',
                            {
                                plugins: {
                                    legend: {
                                        display: true,
                                        position: 'bottom',
                                        labels: {
                                            padding: 12,
                                            font: { size: 9, weight: '500' },
                                            usePointStyle: true
                                        }
                                    }
                                }
                            }
                        );
                    }
                }
            } catch (error) {
                console.error('Error loading program effectiveness chart:', error);
            }
        },

        async loadSkillAcquisitionChart() {
            try {
                const params = this.buildFilterParams();
                const response = await fetch(`/gig-economy/api/skill-acquisition?${params}`);
                const data = await response.json();

                if (this.charts.skillAcquisition) {
                    this.charts.skillAcquisition.destroy();
                }

                const canvas = document.getElementById('skillAcquisitionChart');
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    if (ctx) {
                        this.charts.skillAcquisition = EnhancedChartFactory.createChart(
                            ctx,
                            'bar',
                            data,
                            'skill-acquisition',
                            {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    x: {
                                        grid: { display: false },
                                        ticks: {
                                            font: { size: 10, weight: '500' },
                                            color: '#374151',
                                            maxRotation: 25, // Slight angle for better readability
                                            padding: 8,
                                            callback: function(value, index) {
                                                const label = this.getLabelForValue(value);
                                                // Truncate skill acquisition method labels
                                                return label.length > 12 ? label.substring(0, 10) + '..' : label;
                                            }
                                        }
                                    },
                                    y: {
                                        beginAtZero: true,
                                        grid: {
                                            color: 'rgba(0,0,0,0.04)',
                                            drawBorder: false
                                        },
                                        ticks: {
                                            font: { size: 10 },
                                            color: '#6b7280',
                                            callback: function(value) {
                                                return value.toLocaleString();
                                            }
                                        }
                                    }
                                }
                            }
                        );
                    }
                }
            } catch (error) {
                console.error('Error loading skill acquisition chart:', error);
            }
        },

        async loadGigChallengesChart() {
            try {
                const params = this.buildFilterParams();
                const response = await fetch(`/gig-economy/api/gig-challenges?${params}`);
                const data = await response.json();

                if (this.charts.gigChallenges) {
                    this.charts.gigChallenges.destroy();
                }

                const canvas = document.getElementById('gigChallengesChart');
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    if (ctx) {
                        this.charts.gigChallenges = EnhancedChartFactory.createChart(
                            ctx,
                            'bar',
                            data,
                            'gig-challenges',
                            {
                                indexAxis: 'y',
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    x: {
                                        beginAtZero: true,
                                        grid: {
                                            color: 'rgba(0,0,0,0.04)',
                                            drawBorder: false
                                        },
                                        ticks: {
                                            font: { size: 10 },
                                            color: '#6b7280',
                                            callback: function(value) {
                                                return value.toLocaleString();
                                            }
                                        }
                                    },
                                    y: {
                                        grid: { display: false },
                                        ticks: {
                                            font: { size: 9, weight: '500' },
                                            color: '#374151',
                                            maxRotation: 0,
                                            padding: 6,
                                            callback: function(value, index) {
                                                const label = this.getLabelForValue(value);
                                                // Truncate challenge labels
                                                return label.length > 30 ? label.substring(0, 27) + '...' : label;
                                            }
                                        }
                                    }
                                }
                            }
                        );
                    }
                }
            } catch (error) {
                console.error('Error loading gig challenges chart:', error);
            }
        },

        async loadSupportNeededChart() {
            try {
                const params = this.buildFilterParams();
                const response = await fetch(`/gig-economy/api/support-needed?${params}`);
                const data = await response.json();

                if (this.charts.supportNeeded) {
                    this.charts.supportNeeded.destroy();
                }

                const canvas = document.getElementById('supportNeededChart');
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    if (ctx) {
                        this.charts.supportNeeded = EnhancedChartFactory.createChart(
                            ctx,
                            'bar',
                            data,
                            'support-needed',
                            {
                                indexAxis: 'y',
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    x: {
                                        beginAtZero: true,
                                        grid: {
                                            color: 'rgba(0,0,0,0.04)',
                                            drawBorder: false
                                        },
                                        ticks: {
                                            font: { size: 10 },
                                            color: '#6b7280',
                                            callback: function(value) {
                                                return value.toLocaleString();
                                            }
                                        }
                                    },
                                    y: {
                                        grid: { display: false },
                                        ticks: {
                                            font: { size: 9, weight: '500' },
                                            color: '#374151',
                                            maxRotation: 0,
                                            padding: 6,
                                            callback: function(value, index) {
                                                const label = this.getLabelForValue(value);
                                                // Truncate support needed labels
                                                return label.length > 28 ? label.substring(0, 25) + '...' : label;
                                            }
                                        }
                                    }
                                }
                            }
                        );
                    }
                }
            } catch (error) {
                console.error('Error loading support needed chart:', error);
            }
        },

        async loadMonthlyIncomeChart() {
            try {
                const params = this.buildFilterParams();
                const response = await fetch(`/gig-economy/api/monthly-income?${params}`);
                const data = await response.json();

                if (this.charts.monthlyIncome) {
                    this.charts.monthlyIncome.destroy();
                }

                const canvas = document.getElementById('monthlyIncomeChart');
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    if (ctx) {
                        this.charts.monthlyIncome = EnhancedChartFactory.createChart(
                            ctx,
                            'bar',
                            data,
                            'monthly-income',
                            {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    x: {
                                        grid: { display: false },
                                        ticks: {
                                            font: { size: 9, weight: '500' },
                                            color: '#374151',
                                            maxRotation: 35, // Better angle for income ranges
                                            padding: 8,
                                            callback: function(value, index) {
                                                const label = this.getLabelForValue(value);
                                                // Shorten income range labels
                                                if (label.includes('RM')) {
                                                    return label.replace('RM', '').replace(' - ', '-');
                                                }
                                                return label.length > 10 ? label.substring(0, 8) + '..' : label;
                                            }
                                        }
                                    },
                                    y: {
                                        beginAtZero: true,
                                        grid: {
                                            color: 'rgba(0,0,0,0.04)',
                                            drawBorder: false
                                        },
                                        ticks: {
                                            font: { size: 10 },
                                            color: '#6b7280',
                                            stepSize: 1,
                                            callback: function(value) {
                                                return Math.round(value);
                                            }
                                        }
                                    }
                                },
                                plugins: {
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                return `${context.label}: ${context.parsed.y} respondents`;
                                            }
                                        }
                                    }
                                }
                            }
                        );
                    }
                }
            } catch (error) {
                console.error('Error loading monthly income chart:', error);
            }
        },

        async loadJobPreferenceChart() {
            try {
                const params = this.buildFilterParams();
                const response = await fetch(`/gig-economy/api/job-preference?${params}`);
                const data = await response.json();

                if (this.charts.jobPreference) {
                    this.charts.jobPreference.destroy();
                }

                const canvas = document.getElementById('jobPreferenceChart');
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    if (ctx) {
                        this.charts.jobPreference = EnhancedChartFactory.createChart(
                            ctx,
                            'pie',
                            data,
                            'job-preference',
                            {
                                plugins: {
                                    legend: {
                                        display: true,
                                        position: 'bottom',
                                        labels: {
                                            padding: 15,
                                            font: { size: 10, weight: '500' },
                                            usePointStyle: true
                                        }
                                    }
                                }
                            }
                        );
                    }
                }
            } catch (error) {
                console.error('Error loading job preference chart:', error);
            }
        },

        buildFilterParams() {
            const params = new URLSearchParams();
            Object.entries(this.filters).forEach(([key, values]) => {
                if (Array.isArray(values) && values.length > 0) {
                    const paramKey = key === 'graduation_year' ? 'Tahun graduasi anda?' :
                        key === 'gender' ? 'Jantina anda?' : key;
                    values.forEach(value => params.append(paramKey, value));
                }
            });
            return params.toString();
        },

        applyFilters() {
            this.updateActiveFiltersCount();
            this.dataLoaded = false;
            this.loadData();
            this.showToast('Filters applied', 'success');
        },

        clearAllFilters() {
            this.filters = {
                graduation_year: [],
                gender: []
            };
            this.updateActiveFiltersCount();
            this.dataLoaded = false;
            this.loadData();
            this.showToast('Filters cleared', 'info');
        },

        updateActiveFiltersCount() {
            this.activeFiltersCount = Object.values(this.filters).reduce((count, filter) => {
                return count + (Array.isArray(filter) ? filter.length : 0);
            }, 0);
        },

        async refreshData() {
            this.dataLoaded = false;
            await this.loadData();
            this.showToast('Data refreshed', 'success');
        },

        async refreshChart(chartType) {
            try {
                switch(chartType) {
                    case 'gigTypes':
                        await this.loadGigTypesChart();
                        break;
                    case 'universitySupport':
                        await this.loadUniversitySupportChart();
                        break;
                    case 'universityPrograms':
                        await this.loadUniversityProgramsChart();
                        break;
                    case 'programEffectiveness':
                        await this.loadProgramEffectivenessChart();
                        break;
                    case 'gigMotivations':
                        await this.loadGigMotivationsChart();
                        break;
                    case 'skillAcquisition':
                        await this.loadSkillAcquisitionChart();
                        break;
                    case 'gigChallenges':
                        await this.loadGigChallengesChart();
                        break;
                    case 'supportNeeded':
                        await this.loadSupportNeededChart();
                        break;
                    case 'monthlyIncome':
                        await this.loadMonthlyIncomeChart();
                        break;
                    case 'jobPreference':
                        await this.loadJobPreferenceChart();
                        break;
                }
                this.showToast('Chart refreshed', 'success');
            } catch (error) {
                console.error('Error refreshing chart:', error);
                this.showToast('Error refreshing chart', 'error');
            }
        },

        async exportData(format) {
            try {
                const params = this.buildFilterParams();
                const url = `/gig-economy/api/export?format=${format}&${params}`;
                window.open(url, '_blank');
                this.showToast(`Exporting ${format.toUpperCase()}...`, 'info');
            } catch (error) {
                console.error('Export error:', error);
                this.showToast('Export failed', 'error');
            }
        },

        openTableModal(title) {
            const params = this.buildFilterParams();
            if (typeof openModal === 'function') {
                openModal(title, `/gig-economy/api/table-data?${params}`);
            } else {
                // Fallback - open in new window
                window.open(`/gig-economy/table?${params}`, '_blank');
            }
        },

        showToast(message, type = 'info') {
            // Create toast notification
            const toast = document.createElement('div');
            const colors = {
                success: 'bg-emerald-500 text-white border-emerald-600',
                error: 'bg-red-500 text-white border-red-600',
                info: 'bg-blue-500 text-white border-blue-600',
                warning: 'bg-amber-500 text-white border-amber-600'
            };

            const icons = {
                success: '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>',
                error: '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>',
                info: '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/></svg>',
                warning: '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>'
            };

            toast.className = `fixed top-4 right-4 ${colors[type]} px-4 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 border-l-4 font-medium`;
            toast.innerHTML = `
                <div class="flex items-center">
                    <div class="flex-shrink-0 mr-3">
                        ${icons[type]}
                    </div>
                    <div class="text-sm font-medium">${message}</div>
                </div>
            `;

            document.body.appendChild(toast);

            // Animate in
            setTimeout(() => toast.style.transform = 'translateX(0)', 10);

            // Animate out and remove
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 3500);
        },

        // Method to preview current color schemes (for development)
        previewColors() {
            if (typeof ColorSchemeManager !== 'undefined') {
                ColorSchemeManager.previewAllSchemes();
            } else {
                console.log('ColorSchemeManager not loaded');
            }
        },

        // Method to get current chart mappings (for development)
        getChartMappings() {
            if (typeof ChartConfig !== 'undefined') {
                console.log('Current chart mappings for Gig Economy:');
                const gigEconomyEndpoints = [
                    'gig-types', 'university-support', 'university-programs', 
                    'program-effectiveness', 'gig-motivations', 'skill-acquisition',
                    'gig-challenges', 'support-needed', 'monthly-income', 'job-preference'
                ];
                
                gigEconomyEndpoints.forEach(endpoint => {
                    const scheme = ChartConfig.chartMappings[endpoint] || 'default';
                    console.log(`${endpoint}: ${scheme}`);
                });
            }
        }
    }
}

// Make dashboard available globally for development/debugging
window.gigEconomyDashboard = gigEconomyDashboard;

// Auto-initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Add debug capabilities if in development mode
    if (window.location.search.includes('debug=true')) {
        console.log('Gig Economy Debug mode enabled');
        // You can call dashboard.previewColors() or dashboard.getChartMappings() in console
    }
});
</script>

{% endblock %}